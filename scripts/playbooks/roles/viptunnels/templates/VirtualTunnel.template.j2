#!/bin/sh
# Script to create Virtual tunnels between machines
# Auto-generated by Ansible Playbook
{# assign third and fourth digit #}
{# if you are reading this code, I apologize for the ugly inflexible hard-coding #}
{# I just don't have the time to become good at this.  #}
{% if "sasviya" in cur_ext_host  %}
{% set third_digit = 1 %}
{% set fourth_digit = cur_ext_host[7:9] | int %}
{% elif "sascas" in cur_ext_host  %}
{% set third_digit = 2 %}
{% set fourth_digit = cur_ext_host[6:8] | int %}
{% elif "sascdh" in cur_ext_host  %}
{% set third_digit = 3 %}
{% set fourth_digit = cur_ext_host[6:8] | int %}
{% elif "sashdp" in cur_ext_host  %}
{% set third_digit = 4 %}
{% set fourth_digit = cur_ext_host[6:8] | int %}
{% elif "sasesp" in cur_ext_host  %}
{% set third_digit = 5 %}
{% set fourth_digit = cur_ext_host[6:9] | int %}
{% elif "sasnode" in cur_ext_host  %}
{% set third_digit = 6 %}
{% set fourth_digit = cur_ext_host[7:9] | int %}
{% else  %}
{% set third_digit = 9 %}
{% set fourth_digit = 9 %}
{% endif %}
{# debug: #}
{# {{cur_ext_host}} {{fourth_digit}} #}

for i in `ip tunnel show | grep  "tun"  | awk -F ":" '{print $1;}'`; do echo "Removing tunnel $i"; ip link set ${i} down; ip tunnel del ${i}; done

# Set environment variables
## get the int name, replace int with sas , to get ext name
ext_host=`hostname | sed  's/int/sas/'`
## get the ext IP of the current host
myLocalEXTIP=`getent ahosts $ext_host |awk 'NR==1{print $1}'`
{# myLocalINTIP="192.168.{{third_digit}}.{{ play_hosts.index(inventory_hostname) + 1 | int }}"  #}
# this script is on server {{cur_ext_host}}
myLocalINTIP="192.168.{{third_digit}}.{{ fourth_digit }}"

{% for item in ext_host_list %}
{% if "sasviya" in item  %}
{% set third_digit = 1 %}
{% set fourth_digit = item[7:9] | int %}
{% elif "sascas" in item  %}
{% set third_digit = 2 %}
{% set fourth_digit = item[6:8] | int %}
{% elif "sascdh" in item  %}
{% set third_digit = 3 %}
{% set fourth_digit = item[6:8] | int %}
{% elif "sashdp" in item  %}
{% set third_digit = 4 %}
{% set fourth_digit = item[6:8] | int %}
{% elif "sasesp" in item  %}
{% set third_digit = 5 %}
{% set fourth_digit = item[6:9] | int %}
{% elif "sasnode" in item  %}
{% set third_digit = 6 %}
{% set fourth_digit = item[7:9] | int %}
{% else  %}
{% set third_digit = 9 %}
{% set fourth_digit = 9 %}
{% endif %}
RemoteIP{{loop.index}}=`getent ahosts {{item}} |awk 'NR==1{print $1}'`
INTIP{{loop.index}}="192.168.{{third_digit}}.{{fourth_digit}}"

{% endfor %}


{% for item in int_host_list  %}
ip tunnel add tun{{ loop.index }} mode gre remote $RemoteIP{{loop.index}} local $myLocalEXTIP ttl 255
ip link set tun{{ loop.index }} up
ip addr add ${myLocalINTIP} dev tun{{ loop.index }}
ip route add $INTIP{{loop.index}}/32 dev tun{{ loop.index }}

{% endfor %}
